# @file description-main.R
#
# Copyright 2022 Observational Health Data Sciences and Informatics
#
# This file is part of OhdsiShinyModules
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.



#' The location of the phevaluator module helper file
#' 
#' @details Returns the location of the cohort-generator helper file
#' 
#' @return String location of the phevaluator helper file
#' 
#' @export 
#'
phevaluatorHelperFile <- function() {
  fileLoc <-
    system.file('phevaluator-www', "phevaluator.html", package = "OhdsiShinyModules")
  return(fileLoc)
}


#' The viewer of the phevaluator module
#'
#' @param id The unique reference id for the module
#'
#' @return The user interface to the phevaluator results viewer
#' 
#' @export
#'
phevaluatorViewer <- function(id) {
  ns <- shiny::NS(id)
  
  shinydashboard::box(
    status = 'info',
    width = "100%",
    title =  shiny::span(shiny::icon("gauge"), "PheValuator"),
    solidHeader = TRUE,
    
    shinydashboard::box(
      collapsible = TRUE,
      collapsed = FALSE,
      title = shiny::span( shiny::icon("circle-question"), "Help & Information"),
      width = "100%",
      shiny::htmlTemplate(system.file("phevaluator-www", "phevaluator.html", package = utils::packageName()))
    ),
    
    shinydashboard::box(
      collapsible = TRUE,
      collapsed = FALSE,
      title = shiny::span( shiny::icon("gear"), "Options"),
      width = "100%",
      shiny::uiOutput(ns('phevalOptionsSelector'))
    ),
    
    shiny::conditionalPanel(
      condition = "input.generate != 0",
      ns = ns,
      
      shiny::uiOutput(ns("inputsText")), 
      
      shiny::tabsetPanel(
        type = 'pills',
        id = ns('mainPanel'),
        
        shiny::tabPanel(
          title = "Phenotypes",
          resultTableViewer(ns("cohortDefinitionSetTable"),
                            downloadedFileName = "cohortDefinitionSetTable-")
        ),
        shiny::tabPanel(
          title = "Phenotype Performance Characteristics",
          resultTableViewer(ns("algorithmPerformanceResultsTable"),
                            downloadedFileName = "algorithmPerformanceResultsTable-")
        ),
        shiny::tabPanel(
          title = "Model Covariates",
          resultTableViewer(ns("modelCovariatesTable"),
                            downloadedFileName = "modelCovariatesTable-")
        ),
        shiny::tabPanel(
          title = "Model Performance",
          resultTableViewer(ns("modelPerformanceTable"),
                            downloadedFileName = "modelPerformanceTable-")
        ),
        shiny::tabPanel(
          title = "Model Input Parameters",
          resultTableViewer(ns("modelInputParametersTable"),
                            downloadedFileName = "modelInputParametersTable-")
        ),
        shiny::tabPanel(
          title = "Evaluation Cohort Diagnostics",
          resultTableViewer(ns("diagnosticsTable"),
                            downloadedFileName = "diagnosticsTable-")
        ),
        shiny::tabPanel(
          title = "Evaluation Cohort Parameters",
          resultTableViewer(ns("evaluationInputParametersTable"),
                            downloadedFileName = "evaluationInputParametersTable-")
        ),
        shiny::tabPanel(
          title = "Test Subjects",
          resultTableViewer(ns("testSubjectsTable"),
                            downloadedFileName = "testSubjectsTable-")
        ),
        shiny::tabPanel(
          title = "Test Subjects Covariates",
          resultTableViewer(ns("testSubjectsCovariatesTable"),
                            downloadedFileName = "testSubjectsCovariatesTable-")
        )
      )
    )
  )
}


#' The module server for the main phevaluator module
#'
#' @param id The unique reference id for the module
#' @param connectionHandler A connection to the database with the results
#' @param resultDatabaseSettings A named list containing the cohort generator results database details (schema, table prefix) 
#'
#' @return The phevaluator main module server
#' 
#' @export
#'

phevaluatorServer <- function(
  id, 
  connectionHandler, 
  resultDatabaseSettings
) {
  
  shiny::moduleServer(
    id,
    function(input, output, session) {
      
      ns <- session$ns
      
      withTooltip <- function(value, tooltip, ...) {
        shiny::div(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help",
                   tippy::tippy(value, tooltip, ...))
      }
      
      #use algorithm performance table to get "option columns",
      #which will be used to make choices before generating result(s)
      optionCols <- getPhevalAlgorithmPerformance(
        connectionHandler = connectionHandler,
        resultsSchema = resultDatabaseSettings$schema,
        tablePrefix = resultDatabaseSettings$tablePrefix
      ) %>%
        dplyr::select("databaseId", "phenotype")
      
      databaseIds = unique(optionCols$databaseId)
      phenotypeNames = unique(optionCols$phenotype)
      
      #build the selector
      output$phevalOptionsSelector <- shiny::renderUI({
        
        shiny::fluidPage(
          shiny::fluidRow(
            shiny::column(
              width = 6,
              shinyWidgets::pickerInput(
                inputId = session$ns('selectedDatabaseIds'), 
                label = 'Database(s):', 
                choices = databaseIds, 
                selected = databaseIds,
                choicesOpt = list(style = rep_len("color: black;", 999)),
                multiple = T,
                options = shinyWidgets::pickerOptions(
                  actionsBox = TRUE,
                  liveSearch = TRUE,
                  size = 10,
                  liveSearchStyle = "contains",
                  liveSearchPlaceholder = "Type here to search",
                  virtualScroll = 50
                ),
                width = "100%"
              )
            ),
            shiny::column(
              width = 6,
              shinyWidgets::pickerInput(
                inputId = session$ns('selectedPhenotypes'), 
                label = 'Phenotype(s):', 
                choices = phenotypeNames, 
                selected = phenotypeNames,
                choicesOpt = list(style = rep_len("color: black;", 999)),
                multiple = T,
                options = shinyWidgets::pickerOptions(
                  actionsBox = TRUE,
                  liveSearch = TRUE,
                  size = 10,
                  liveSearchStyle = "contains",
                  liveSearchPlaceholder = "Type here to search",
                  virtualScroll = 50
                ),
                width = "100%"
              )
            )
          ),
          shiny::actionButton(
            inputId = session$ns('generate'),
            label = 'Generate Results'
          )
        )
      })
      
      #if generate is pushed, extract the data
      dataAlgorithmPerformance <- shiny::eventReactive(         #we care about returning this value, so we use eventReactive
        eventExpr = input$generate,                     #could add complexity to event if desired
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalAlgorithmPerformance(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes) %>%
            dplyr::select("databaseId":"cohortId", "description", "sensitivity95Ci":"analysisId")
        }
      )
      
      dataCohortDefinitionSet <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalCohortDefinitionSet(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::mutate(buttonSQL = makeButtonLabel("SQL"),
                          buttonJSON = makeButtonLabel("JSON")) %>%
            dplyr::filter(phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataDiagnostics <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalDiagnostics(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataEvalInputParams <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalEvalInputParams(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataModelCovars <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalModelCovars(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataModelInputParams <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalModelInputParams(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataModelPerformance <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalModelPerformance(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataTestSubjects <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }
          
          getPhevalTestSubjects(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      dataTestSubjectsCovars <- shiny::eventReactive(
        eventExpr = input$generate,                     
        {
          if (is.null(input$selectedDatabaseIds) |
              is.null(input$selectedPhenotypes)) {
            data.frame()
          }

          getPhevalTestSubjectsCovars(
            connectionHandler = connectionHandler,
            resultsSchema = resultDatabaseSettings$schema,
            tablePrefix = resultDatabaseSettings$tablePrefix
          ) %>%
            dplyr::filter(databaseId %in% input$selectedDatabaseIds & 
                            phenotype %in% input$selectedPhenotypes)
        }
      )
      
      
      
      
      selectedInputs <- shiny::reactiveVal()
      output$inputsText <- shiny::renderUI(selectedInputs())
      
      #when generate is pushed, return as text what was selected
      shiny::observeEvent(
        eventExpr = input$generate,
        {
          selectedInputs(
            shinydashboard::box(
              status = 'warning',
              width = "100%",
              title = 'Selected:',
              shiny::div(shiny::fluidRow(
                shiny::column(
                  width = 8,
                  shiny::tags$b("Phenotype(s):"),
                  
                  paste(unique(optionCols$databaseId[optionCols$databaseId %in% input$selectedDatabaseIds]),
                        collapse = ', ')
                  
                ),
                shiny::column(
                  width = 4,
                  shiny::tags$b("Database(s):"),
                  paste(unique(optionCols$phenotype[optionCols$phenotype %in% input$selectedPhenotypes]),
                        collapse = ', ')
                )
              ))
            )
          )
        }
      )
      
      #read in custom column name colDef list from rds file, generated by 
      #heplers-componentsCreateCustomColDefList.R
      
      phevalColList <- ParallelLogger::loadSettingsFromJson(system.file("components-columnInformation",
                                                                        "phevaluator-colDefs.json",
                                                                        package = "OhdsiShinyModules")
      )
      
      #define custom colDefs for SQL and JSON buttons
      buttonColDefs <- list(
        buttonSQL = reactable::colDef(header = withTooltip("SQL", "Downloads SQL code for the cohort"),
                                html = T
                                ),
        buttonJSON = reactable::colDef(header = withTooltip("JSON", "Downloads JSON code for the cohort"),
                                 html = T
                                 ),
        sql = reactable::colDef(show = F),
        json = reactable::colDef(show = F)
      )
      
      #define custom column definitions and render the result table
      customColDefs <- utils::modifyList(phevalColList, buttonColDefs)

      
      resultTableServer(id = ns("algorithmPerformanceResultsTable"),
                        df = dataAlgorithmPerformance,
                        colDefsInput = customColDefs,
                        downloadedFileName = "algorithmPerformanceResultsTable-")
      
      resultTableServer(id = ns("cohortDefinitionSetTable"),
                        df = dataCohortDefinitionSet,
                        colDefsInput = customColDefs,
                        downloadedFileName = "cohortDefinitionSetTable-")
      
      resultTableServer(id = ns("diagnosticsTable"),
                        df = dataDiagnostics,
                        colDefsInput = customColDefs,
                        downloadedFileName = "diagnosticsTable-")
      
      resultTableServer(id = ns("evaluationInputParametersTable"),
                        df = dataEvalInputParams,
                        colDefsInput = customColDefs,
                        downloadedFileName = "evaluationInputParametersTable-")
      
      resultTableServer(id = ns("modelCovariatesTable"),
                        df = dataModelCovars,
                        colDefsInput = customColDefs,
                        downloadedFileName = "modelCovariatesTable-")
      
      resultTableServer(id = ns("modelInputParametersTable"),
                        df = dataModelInputParams,
                        colDefsInput = customColDefs,
                        downloadedFileName = "modelInputParametersTable-")
      
      resultTableServer(id = ns("modelPerformanceTable"),
                        df = dataModelPerformance,
                        colDefsInput = customColDefs,
                        downloadedFileName = "modelPerformanceTable-")
      
      resultTableServer(id = ns("testSubjectsTable"),
                        df = dataTestSubjects,
                        colDefsInput = customColDefs,
                        downloadedFileName = "testSubjectsTable-")
      
      resultTableServer(id = ns("testSubjectsCovariatesTable"),
                        df = dataTestSubjectsCovars,
                        colDefsInput = customColDefs,
                        downloadedFileName = "testSubjectsCovariatesTable-")
      
      return(invisible(NULL))
      
    })
}








