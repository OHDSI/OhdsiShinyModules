
#' The location of the evidence synthesis module helper file
#'
#' @details
#' Returns the location of the evidence synthesis helper file
#' 
#' @return
#' string location of the evidence synthesis helper file
#'
#' @export
evidenceSynthesisHelperFile <- function(){
  fileLoc <- system.file('evidence-synthesis-www', "evidence-synthesis.html", package = "OhdsiShinyModules")
  return(fileLoc)
}

#' The module viewer for exploring evidence-synthesis
#'
#' @details
#' The user specifies the id for the module
#'
#' @param id  the unique reference id for the module
#' 
#' @return
#' The user interface to the evidence-synthesis viewer module
#'
#' @export
evidenceSynthesisViewer <- function(id=1) {
  ns <- shiny::NS(id)
  
  shiny::tabsetPanel(
    id = ns('evidenceSynthesisMainView'),
    
    shiny::tabPanel(
      "Cohort Method",  
      evidenceSynthesisCohortViewer(ns('evidenceSynthesisCohortTab'))
    )#,
    
    #shiny::tabPanel(
    #  "SCCS",  
    #  evidenceSynthesisSCCSViewer(ns('evidenceSynthesisSccsTab'))
    #  )
    )
  
}


#' The module server for exploring PatientLevelPrediction
#'
#' @details
#' The user specifies the id for the module
#'
#' @param id  the unique reference id for the module
#' @param connectionHandler a connection to the database with the results
#' @param resultDatabaseSettings a list containing the prediction result schema and connection details
#' 
#' @return
#' The server for the PatientLevelPrediction module
#'
#' @export
evidenceSynthesisServer <- function(
    id, 
    connectionHandler,
    resultDatabaseSettings = list(port = 1)
) {
  shiny::moduleServer(
    id,
    function(input, output, session) {
      
      evidenceSynthesisCohortServer(
        id = 'evidenceSynthesisCohortTab', 
        connectionHandler = connectionHandler,  
        mySchema = resultDatabaseSettings$schema, 
        esTablePrefix = resultDatabaseSettings$tablePrefix,
        cmTablePrefix = resultDatabaseSettings$cmTablePrefix,
        cgTablePrefix = resultDatabaseSettings$cgTablePrefix,
        databaseMetaData = resultDatabaseSettings$databaseMetaData
      )
      
      #evidenceSynthesisSccsServer(
      #  id = 'evidenceSynthesisSccsTab', 
      #  connectionHandler = connectionHandler,  
      #  mySchema = resultDatabaseSettings$schema, 
      #  esTablePrefix = resultDatabaseSettings$tablePrefix,
      #  cmTablePrefix = resultDatabaseSettings$cmTablePrefix,
      #  cgTablePrefix = resultDatabaseSettings$cgTablePrefix,
      #  databaseMetaData = resultDatabaseSettings$databaseMetaData
      #)
      
    }
    )
  
}

evidenceSynthesisCohortViewer <- function(id) {
  ns <- shiny::NS(id)
  
  shiny::div(
    
    shinydashboard::box(
      status = 'info', 
      width = 12,
      title = 'Evidence Synthesis Results',
      solidHeader = TRUE,
      
      shiny::uiOutput(ns('esCohortMethodSelect'))
      ),
      
      shiny::fluidRow(
        shinydashboard::tabBox(
          width = 12,
          title = shiny::tagList(shiny::icon("gear"), "Plot and Table"),
          id = ns('esCohortTabs'),
          shiny::tabPanel("Plot",
            shiny::plotOutput(ns('esCohortMethodPlot'))
          ),
          shiny::tabPanel("Table",
            shiny::tableOutput(ns('esCohortMethodTable'))
          )
        )
      )
  )
}

evidenceSynthesisCohortServer <- function(
    id, 
    connectionHandler,
    mySchema, 
    esTablePrefix,
    cmTablePrefix,
    cgTablePrefix,
    databaseMetaData
) {
  shiny::moduleServer(
    id,
    function(input, output, session) {
      
      targetIds <- getESTargetIds(
        connectionHandler,
        mySchema, 
        cmTablePrefix,
        cgTablePrefix
      )
      outcomeIds <- getESOutcomeIds(
          connectionHandler,
          mySchema, 
          cmTablePrefix,
          cgTablePrefix
      )
      
      targetId <- shiny::reactiveVal(targetIds[1])
      outcomeId <- shiny::reactiveVal(outcomeIds[1])
      
      output$esCohortMethodSelect <- shiny::renderUI({
        
          tagList(
          shiny::selectInput(
            inputId = session$ns('selectedTargetId'), 
            label = 'Target:', 
            choices = targetIds, 
            selected = 1,
            multiple = F, 
            selectize=FALSE
          ),
          shiny::selectInput(
            inputId = session$ns('selectedOutcomeId'), 
            label = 'Outcome:', 
            choices = outcomeIds, 
            selected = 1,
            multiple = F, 
            selectize=FALSE
          )
        )
      })

      shiny::observeEvent(input$selectedTargetId,{
        targetId(input$selectedTargetId)
      })
      shiny::observeEvent(input$selectedOutcomeId,{
        outcomeId(input$selectedOutcomeId)
      })
      
      data <- shiny::reactive({
        getCMEstimation(
        connectionHandler = connectionHandler,
        mySchema = mySchema,
        cmTablePrefix = cmTablePrefix,
        cgTablePrefix = cgTablePrefix,
        databaseMetaData = 'database_meta_data',
        targetId = targetId(),
        outcomeId = outcomeId()
      )
      })
      
      data2 <- shiny::reactive({
        getMetaEstimation(
        connectionHandler = connectionHandler,
        mySchema = mySchema,
        cmTablePrefix = cmTablePrefix,
        cgTablePrefix = cgTablePrefix,
        esTablePrefix = esTablePrefix,
        databaseMetaData = databaseMetaData,
        targetId = targetId(),
        outcomeId = outcomeId()
      )
      })
      
      output$esCohortMethodPlot <- shiny::renderPlot(
        createPlotForAnalysis(
          unique(rbind(data(),data2()))
        )
      )
      
      output$esCohortMethodTable <- shiny::renderTable(
          unique(rbind(data(),data2())) %>%
            dplyr::select(
              -c("targetId","outcomeId", "comparatorId", "analysisId")
              )
      )
      
    }
  )
}
    
getESTargetIds <- function(
  connectionHandler,
  mySchema, 
  cmTablePrefix,
  cgTablePrefix
){
  
  sql <- "select distinct
  c1.cohort_name as target,
  r.target_id
  
  from 
   @my_schema.@cm_table_prefixresult as r
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c1
   on c1.cohort_definition_id = r.target_id
  ;"
  
  result <- connectionHandler$queryDb(
    sql = sql,
    my_schema = mySchema,
    cm_table_prefix = cmTablePrefix,
    cg_table_prefix = cgTablePrefix
  ) 
  
  output <- as.list(result$targetId)
  names(output) <- result$target
  
  return(output)
  
}

getESOutcomeIds <- function(
  connectionHandler,
  mySchema, 
  cmTablePrefix,
  cgTablePrefix
) {
  sql <- "select distinct
  c1.cohort_name as outcome,
  r.outcome_id
  
  from 
   @my_schema.@cm_table_prefixresult as r
   inner join 
   @my_schema.@cm_table_prefixtarget_comparator_outcome as tco
   on 
   r.target_id = tco.target_id and 
   r.comparator_id = tco.comparator_id and 
   r.outcome_id = tco.outcome_id
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c1
   on c1.cohort_definition_id = r.outcome_id
   
  where 
  tco.outcome_of_interest = 1
  ;"
  
  result <- connectionHandler$queryDb(
    sql = sql,
    my_schema = mySchema,
    cm_table_prefix = cmTablePrefix,
    cg_table_prefix = cgTablePrefix
  ) 
  
  output <- as.list(result$outcomeId)
  names(output) <- result$outcome
  
  return(output)
  
} 


getCMEstimation <- function(
    connectionHandler,
    mySchema,
    cmTablePrefix = 'cm_',
    cgTablePrefix = 'cg_',
    databaseMetaData = 'database_meta_data',
    targetId,
    outcomeId
    ){
  sql <- "select 
  c1.cohort_name as target,
  c2.cohort_name as comparator,
  c3.cohort_name as outcome,
  r.target_id, r.comparator_id, r.outcome_id, r.analysis_id, 
  a.description,
  db.cdm_source_abbreviation as database, r.calibrated_rr, 
  r.calibrated_ci_95_lb, r.calibrated_ci_95_ub, r.calibrated_p,
  r.calibrated_log_rr, r.calibrated_se_log_rr
  
  from 
   @my_schema.@cm_table_prefixresult as r
   inner join 
   @my_schema.@cm_table_prefixtarget_comparator_outcome as tco
   on 
   r.target_id = tco.target_id and 
   r.comparator_id = tco.comparator_id and 
   r.outcome_id = tco.outcome_id
   
   inner join
   
   @my_schema.@cm_table_prefixdiagnostics_summary as unblind
   on
   r.analysis_id = unblind.analysis_id and 
   r.target_id = unblind.target_id and 
   r.comparator_id = unblind.comparator_id and 
   r.outcome_id = unblind.outcome_id and 
   r.database_id = unblind.database_id
   
   inner join
   @my_schema.@database_meta_data as db
   on db.database_id = r.database_id
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c1
   on c1.cohort_definition_id = r.target_id
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c2
   on c2.cohort_definition_id = r.comparator_id
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c3
   on c3.cohort_definition_id = r.outcome_id
   
   inner join
   @my_schema.@cm_table_prefixanalysis as a
   on a.analysis_id = r.analysis_id
   
   where 
   r.calibrated_rr != 0 and
   tco.outcome_of_interest = 1 and
   unblind.unblind = 1 and
   r.target_id = @target_id and
   r.outcome_id = @outcome_id
  ;"
  
  result <- connectionHandler$queryDb(
    sql = sql,
    my_schema = mySchema,
    database_meta_data = databaseMetaData,
    cm_table_prefix = cmTablePrefix,
    cg_table_prefix = cgTablePrefix,
    outcome_id = outcomeId,
    target_id = targetId
  ) %>%
    dplyr::mutate(
      calibratedP = ifelse(
        .data$calibratedRr < 1, 
        computeTraditionalP(
          logRr = .data$calibratedLogRr, 
          seLogRr = .data$calibratedSeLogRr, 
          twoSided = FALSE, 
          upper = TRUE
        ),
        .data$calibratedP / 2)
      )
    
  return(result)
}

getMetaEstimation <- function(
    connectionHandler,
    mySchema,
    cmTablePrefix = 'cm_',
    cgTablePrefix = 'cg_',
    esTablePrefix = 'es_',
    databaseMetaData = 'database_meta_data',
    targetId,
    outcomeId
){

sql <- "select 
  c1.cohort_name as target,
  c2.cohort_name as comparator,
  c3.cohort_name as outcome,
  r.target_id, r.comparator_id, r.outcome_id, r.analysis_id, 
  a.description,
  ev.evidence_synthesis_description as database,
  r.calibrated_rr, 
  r.calibrated_ci_95_lb, r.calibrated_ci_95_ub, r.calibrated_p,
  r.calibrated_log_rr, r.calibrated_se_log_rr
  
  from 
   @my_schema.@es_table_prefixcm_result as r
   inner join 
   @my_schema.@cm_table_prefixtarget_comparator_outcome as tco
   on 
   r.target_id = tco.target_id and 
   r.comparator_id = tco.comparator_id and 
   r.outcome_id = tco.outcome_id
   
   inner join
   
   @my_schema.@es_table_prefixcm_diagnostics_summary as unblind
   on
   r.analysis_id = unblind.analysis_id and 
   r.target_id = unblind.target_id and 
   r.comparator_id = unblind.comparator_id and 
   r.outcome_id = unblind.outcome_id 
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c1
   on c1.cohort_definition_id = r.target_id
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c2
   on c2.cohort_definition_id = r.comparator_id
   
   inner join
   @my_schema.@cg_table_prefixcohort_definition as c3
   on c3.cohort_definition_id = r.outcome_id
   
   inner join
   @my_schema.@cm_table_prefixanalysis as a
   on a.analysis_id = r.analysis_id
   
   inner join
   @my_schema.@es_table_prefixanalysis as ev
   on ev.evidence_synthesis_analysis_id = r.evidence_synthesis_analysis_id
   
   where 
   r.calibrated_rr != 0 and
   tco.outcome_of_interest = 1 and
   unblind.unblind = 1 and
   r.target_id = @target_id and
   r.outcome_id = @outcome_id
  ;"

result <- connectionHandler$queryDb(
  sql = sql,
  my_schema = mySchema,
  cm_table_prefix = cmTablePrefix,
  cg_table_prefix = cgTablePrefix,
  es_table_prefix = esTablePrefix,
  outcome_id = outcomeId,
  target_id = targetId
) %>%
  dplyr::mutate(
    calibratedP = ifelse(
      .data$calibratedRr < 1, 
      computeTraditionalP(
        logRr = .data$calibratedLogRr, 
        seLogRr = .data$calibratedSeLogRr, 
        twoSided = FALSE, 
        upper = TRUE
      ),
      .data$calibratedP / 2)
  )

return(result)
}

createPlotForAnalysis <- function(data) {
  
  compText <- data.frame(
    comparatorText = paste0('Comp', 1:length(unique(data$comparator))),
    comparator = unique(data$comparator)
  )
  
  data <- merge(
    data, 
    compText,
    by = "comparator"
  )

    breaks <- c(0.1, 0.25, 0.5, 1, 2, 4, 6, 8)
    title <- sprintf("%s", data$outcome[1])
    plot <- ggplot2::ggplot(
      data = data,
      ggplot2::aes(x = .data$calibratedRr, y = .data$comparatorText)) +
      ggplot2::geom_vline(xintercept = 1, size = 0.5) +
      ggplot2::geom_point(color = "#000088", alpha = 0.8) +
      ggplot2::geom_errorbarh(
        ggplot2::aes(
          xmin = .data$calibratedCi95Lb, 
          xmax = .data$calibratedCi95Ub
          ), 
        height = 0.5, 
        color = "#000088", 
        alpha = 0.8
        ) +
      ggplot2::scale_x_log10(
        "Effect size (Hazard Ratio)", 
        breaks = breaks, 
        labels = breaks
        ) +
      ggplot2::coord_cartesian(xlim = c(0.1, 10)) + 
      ggplot2::facet_grid(.data$database ~ .data$description)  +
      ggplot2::ggtitle(title) +
      ggplot2::theme(
        axis.title.y = ggplot2::element_blank(),
        panel.grid.minor = ggplot2::element_blank(),
        strip.text.y.right = ggplot2::element_text(angle = 0)
        ) + 
      ggplot2::labs(
        caption = paste(
          apply(
            X = compText, 
            MARGIN = 1, 
            FUN = function(x){paste(x,collapse = ': ', sep=':')}
            ), 
          collapse = '; ')
      )
    
  return(plot)
}


computeTraditionalP <- function(
    logRr, 
    seLogRr, 
    twoSided = TRUE, 
    upper = TRUE
    ) 
{
  z <- logRr/seLogRr
  pUpperBound <- 1 - pnorm(z)
  pLowerBound <- pnorm(z)
  if (twoSided) {
    return(2 * pmin(pUpperBound, pLowerBound))
  }
  else if (upper) {
    return(pUpperBound)
  }
  else {
    return(pLowerBound)
  }
}

  